---

# Required vault variables:
#   - gitlab_user_username: Username for the new GitLab owner user
#   - gitlab_user_name: Full name for the new GitLab owner user
#   - gitlab_user_email: Email for the new GitLab owner user
#   - gitlab_user_password: Password for the new GitLab owner user

##############################################
# Wait for GitLab to be ready
##############################################

- name: Wait for GitLab to be fully initialized
  uri:
    url: "{{ gitlab_external_url }}/users/sign_in"
    status_code: 200
  register: gitlab_health
  until: gitlab_health.status == 200
  retries: 120
  delay: 5

##############################################
# Generate root personal access token
##############################################

- name: Generate a random Admin Personal Access Token
  shell: |
    sudo gitlab-rails runner "
    user = User.find_by_username('root');
    token_name = 'AnsibleAutoRootToken';
    user.personal_access_tokens.where(name: token_name).each { |t| t.revoke! };
    
    token = user.personal_access_tokens.create(
      scopes: [:api],
      name: token_name,
      expires_at: 30.days.from_now
    );
    token.save!
    puts token.token
    "
  register: generated_admin_token_output
  no_log: true

- name: Save the admin token as a fact
  set_fact:
    gitlab_root_token: "{{ generated_admin_token_output.stdout | trim }}"
  no_log: true

##############################################
# Create GitLab user
##############################################

- name: Check if user exists
  uri:
    url: "{{ gitlab_external_url }}/api/v4/users?username={{ gitlab_user_username }}"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_root_token }}"
    status_code: [200]
  register: existing_user
  no_log: true

- name: Create new GitLab user via API
  uri:
    url: "{{ gitlab_external_url }}/api/v4/users"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_root_token }}"
    body_format: json
    body:
      email: "{{ gitlab_user_email }}"
      username: "{{ gitlab_user_username }}"
      name: "{{ gitlab_user_name }}"
      password: "{{ gitlab_user_password }}"
      skip_confirmation: true
    status_code: [201, 409]
  register: created_user
  when: (existing_user.json | default([])) | length == 0
  no_log: true

- name: Get user ID
  set_fact:
    gitlab_user_id: "{{ ((existing_user.json | default([]))[0].id if (existing_user.json | default([])) | length > 0 else created_user.json.id) | string }}"

##############################################
# Create user personal access token
##############################################

# scopes: [:api, :read_user, :read_repository, :write_repository],
- name: Generate a random user Personal Access Token
  shell: |
    sudo gitlab-rails runner "
    user = User.find({{ gitlab_user_id }});
    token_name = 'AnsibleAutoUserToken';
    user.personal_access_tokens.where(name: token_name).each { |t| t.revoke! };

    token = user.personal_access_tokens.create(
      scopes: [:api],
      name: token_name,
      expires_at: 30.days.from_now
    );
    token.save!
    puts token.token
    "
  register: generated_user_token_output
  no_log: true

- name: Store user token
  set_fact:
    gitlab_user_token: "{{ generated_user_token_output.stdout | trim }}"
  no_log: true

##############################################
# Create backend project
##############################################

- name: Check if backend project exists
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ gitlab_user_username }}%2Flu.uni.e4l.platform.api.dev"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [200, 404]
  register: existing_backend_project
  no_log: true

- name: Create backend project
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: json
    body:
      path: "lu.uni.e4l.platform.api.dev"
      visibility: "public"
      initialize_with_readme: false
      auto_devops_enabled: false
    status_code: [201, 400]
  register: backend_project
  when: existing_backend_project.status == 404
  no_log: true

- name: Get backend project ID
  set_fact:
    backend_project_id: "{{ (existing_backend_project.json.id if existing_backend_project.status == 200 else backend_project.json.id) | string }}"

##############################################
# Create frontend project
##############################################

- name: Check if frontend project exists
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ gitlab_user_username }}%2Flu.uni.e4l.platform.frontend.dev"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [200, 404]
  register: existing_frontend_project
  no_log: true

- name: Create frontend project
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: json
    body:
      path: "lu.uni.e4l.platform.frontend.dev"
      visibility: "public"
      initialize_with_readme: false
      auto_devops_enabled: false
    status_code: [201, 400]
  register: frontend_project
  when: existing_frontend_project.status == 404
  no_log: true

- name: Get frontend project ID
  set_fact:
    frontend_project_id: "{{ (existing_frontend_project.json.id if existing_frontend_project.status == 200 else frontend_project.json.id) | string }}"

##############################################
# Push local repositories to GitLab
##############################################

- name: Check if backend repository has commits
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ backend_project_id }}/repository/commits"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [200, 404]
  register: backend_commits
  no_log: true

- name: Push backend repository to GitLab
  shell: |
    cd {{ backend_VM_path }}
    git init
    git config user.name "{{ gitlab_user_name }}"
    git config user.email "{{ gitlab_user_email }}"
    git branch -M main
    git remote add origin http://{{ gitlab_user_username }}:{{ gitlab_user_token }}@{{ gitlab_domain }}/gitlab/{{ gitlab_user_username }}/lu.uni.e4l.platform.api.dev.git || true
    git add .
    git commit -m "Initial backend commit" || true
    git push -u origin main -o ci.skip || git push origin main -o ci.skip
  register: backend_push
  changed_when: backend_push.rc == 0
  failed_when: false
  when: backend_commits.status == 404 or (backend_commits.json | length == 0)
  no_log: true

- name: Remove .git directory from backend repository
  file:
    path: "{{ backend_VM_path }}/.git"
    state: absent

- name: Check if frontend repository has commits
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ frontend_project_id }}/repository/commits"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [200, 404]
  register: frontend_commits
  no_log: true

- name: Push frontend repository to GitLab
  shell: |
    cd {{ frontend_VM_path }}
    git init
    git config user.name "{{ gitlab_user_name }}"
    git config user.email "{{ gitlab_user_email }}"
    git branch -M main
    git remote add origin http://{{ gitlab_user_username }}:{{ gitlab_user_token }}@{{ gitlab_domain }}/gitlab/{{ gitlab_user_username }}/lu.uni.e4l.platform.frontend.dev.git || true
    git add .
    git commit -m "Initial frontend commit" || true
    git push -u origin main -o ci.skip || git push origin main -o ci.skip
  args:
    executable: /bin/bash
  register: frontend_push
  changed_when: frontend_push.rc == 0
  failed_when: false
  when: frontend_commits.status == 404 or (frontend_commits.json | length == 0)
  no_log: true

- name: Remove .git directory from frontend repository
  file:
    path: "{{ frontend_VM_path }}/.git"
    state: absent

##############################################
# Set CI/CD environment variables for projects
##############################################

- name: Add backend CI/CD variables
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ backend_project_id }}/variables"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: form-urlencoded
    body:
      key: "{{ item.key }}"
      value: "{{ item.value }}"
      masked: "{{ item.masked }}"
    status_code: [201, 400]
  loop: "{{ backend_cicd_variables }}"
  register: backend_vars_result
  failed_when: backend_vars_result.status not in [201, 400]
  no_log: true

- name: Add frontend CI/CD variables
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ frontend_project_id }}/variables"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: form-urlencoded
    body:
      key: "{{ item.key }}"
      value: "{{ item.value }}"
      masked: "{{ item.masked }}"
    status_code: [201, 400]
  loop: "{{ frontend_cicd_variables }}"
  register: frontend_vars_result
  failed_when: frontend_vars_result.status not in [201, 400]
  no_log: true

##############################################
# Create GitLab runners
##############################################

- name: Unregister all runners from VM
  command: gitlab-runner unregister --all-runners
  become: yes
  changed_when: true
  failed_when: false

- name: List backend project runners
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ backend_project_id }}/runners"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [200]
  register: backend_runners_list
  no_log: true

- name: Delete backend project runners
  uri:
    url: "{{ gitlab_external_url }}/api/v4/runners/{{ item.id }}"
    method: DELETE
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [204, 404]
  loop: "{{ backend_runners_list.json }}"
  when: backend_runners_list.json | length > 0
  no_log: true

- name: List frontend project runners
  uri:
    url: "{{ gitlab_external_url }}/api/v4/projects/{{ frontend_project_id }}/runners"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [200]
  register: frontend_runners_list
  no_log: true

- name: Delete frontend project runners
  uri:
    url: "{{ gitlab_external_url }}/api/v4/runners/{{ item.id }}"
    method: DELETE
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    status_code: [204, 404]
  loop: "{{ frontend_runners_list.json }}"
  when: frontend_runners_list.json | length > 0
  no_log: true

# Backend runners
- name: Create backend docker runner
  uri:
    url: "{{ gitlab_external_url }}/api/v4/user/runners"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: form-urlencoded
    body:
      runner_type: "project_type"
      project_id: "{{ backend_project_id }}"
      description: "[VM] docker"
      tag_list: "docker-runner"
    status_code: [201]
  register: backend_docker_runner
  no_log: true

- name: Register backend docker runner
  command: >
    gitlab-runner register
    --non-interactive
    --url "{{ gitlab_external_url }}/"
    --token "{{ backend_docker_runner.json.token }}"
    --executor "docker"
    --docker-image "alpine:latest"
    --docker-privileged
    --docker-volumes "/etc/docker/certs.d:/etc/docker/certs.d:ro"
  become: yes
  no_log: true

- name: Create backend shell runner
  uri:
    url: "{{ gitlab_external_url }}/api/v4/user/runners"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: form-urlencoded
    body:
      runner_type: "project_type"
      project_id: "{{ backend_project_id }}"
      description: "[VM] shell"
      tag_list: "shell-runner"
    status_code: [201]
  register: backend_shell_runner
  no_log: true

- name: Register backend shell runner
  command: >
    gitlab-runner register
    --non-interactive
    --url "{{ gitlab_external_url }}/"
    --token "{{ backend_shell_runner.json.token }}"
    --executor "shell"
  become: yes
  no_log: true

# Frontend runners
- name: Create frontend docker runner
  uri:
    url: "{{ gitlab_external_url }}/api/v4/user/runners"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: form-urlencoded
    body:
      runner_type: "project_type"
      project_id: "{{ frontend_project_id }}"
      description: "[VM] docker"
      tag_list: "docker-runner"
    status_code: [201]
  register: frontend_docker_runner
  no_log: true

- name: Register frontend docker runner
  command: >
    gitlab-runner register
    --non-interactive
    --url "{{ gitlab_external_url }}/"
    --token "{{ frontend_docker_runner.json.token }}"
    --executor "docker"
    --docker-image "alpine:latest"
    --docker-privileged
    --docker-volumes "/etc/docker/certs.d:/etc/docker/certs.d:ro"
  become: yes
  no_log: true

- name: Create frontend shell runner
  uri:
    url: "{{ gitlab_external_url }}/api/v4/user/runners"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_user_token }}"
    body_format: form-urlencoded
    body:
      runner_type: "project_type"
      project_id: "{{ frontend_project_id }}"
      description: "[VM] shell"
      tag_list: "shell-runner"
    status_code: [201]
  register: frontend_shell_runner
  no_log: true

- name: Register frontend shell runner
  command: >
    gitlab-runner register
    --non-interactive
    --url "{{ gitlab_external_url }}/"
    --token "{{ frontend_shell_runner.json.token }}"
    --executor "shell"
  become: yes
  no_log: true

- name: Restart GitLab runner service
  systemd:
    name: gitlab-runner
    state: restarted
  become: yes