stages:
  - commit
  - staging
  - production

##########################
####   COMMIT STAGE   ####
##########################
build:
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: node:18
  stage: commit
  tags:
    - docker-runner
  script:
    - npm install --save-dev webpack
    - npm run build
  artifacts:
    name: "frontend-build-$CI_COMMIT_SHORT_SHA"
    paths:
      - e4l.frontend.docker/web/dist
    expire_in: 1 hour

test:
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: node:18
  stage: commit
  tags:
    - docker-runner
  needs:
    - job: build
  script:
    - npm install --save-dev webpack
    - npm test
  artifacts:
    when: always
    reports:
      junit: junit.xml

package:
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: docker:29.1.3-cli
  stage: commit
  services:
    - name: docker:29.1.3-dind
      alias: docker
      command: ["--storage-driver=overlay2"]
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  tags:
    - docker-runner
  needs:
    - job: build
      artifacts: true
    - job: test
      artifacts: false
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  script:
    - docker build -t $CI_REGISTRY_IMAGE:latest ./e4l.frontend.docker/web/.
    - docker push $CI_REGISTRY_IMAGE:latest

###########################
####   STAGING STAGE   ####
###########################
deploy_staging:
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  stage: staging
  tags:
    - shell-runner
  needs:
    - job: package
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  script:
    - docker compose -f ./e4l.frontend.docker/docker-compose.frontend.staging.yml pull
    - docker compose -f ./e4l.frontend.docker/docker-compose.frontend.staging.yml up -d
  environment:
    name: staging
    url: http://localhost:8884/

# automated_uat:
#   rules:
#   - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#   - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#   image: selenium/standalone-chrome:latest
#   stage: staging
#   tags:
#     - docker-runner
#   needs:
#     - job: deploy_staging
#   variables:
#     STAGING_URL: "http://172.17.0.1:8884"
#     SCREENSHOT_DIR: "./screenshots"
#   before_script:
#     - pip install selenium
#   script:
#     - python3 tests/uat/screenshot_test.py
#   artifacts:
#     when: always
#     paths:
#       - screenshots/
#     expire_in: 1 week

# promote_image:
#   rules:
#   - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#   image: docker:29.1.3-cli
#   stage: staging
#   services:
#     - name: docker:29.1.3-dind
#       alias: docker
#       command: ["--storage-driver=overlay2"]
#   variables:
#     DOCKER_DRIVER: overlay2
#     DOCKER_HOST: tcp://docker:2375
#     DOCKER_TLS_CERTDIR: ""
#   tags:
#     - docker-runner
#   needs:
#     - job: deploy_staging
#   before_script:
#     - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
#   script:
#     - docker pull "$CI_REGISTRY_IMAGE:latest"
#     - docker tag "$CI_REGISTRY_IMAGE:latest" "$CI_REGISTRY_IMAGE:release"
#     - docker push "$CI_REGISTRY_IMAGE:release"
#   when: manual

##############################
####   PRODUCTION STAGE   ####
##############################
deploy_production:
  rules:
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  stage: production
  tags:
    - shell-runner
  needs:
    - job: deploy_staging
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - docker pull "$CI_REGISTRY_IMAGE:latest"
    - docker tag "$CI_REGISTRY_IMAGE:latest" "$CI_REGISTRY_IMAGE:release"
    - docker push "$CI_REGISTRY_IMAGE:release"
    # Ensure production network exists
    - docker network create e4l-frontend-net-prod || true
  script:
    # Check if the nginx router is running, if not, deploy both blue and green (first deployment)
    - |
      if [ -z "$(docker ps --filter name=e4l-nginx-frontend-prod --format '{{.Names}}')" ]; then
        echo "Nginx not running, first deployment, deploying to blue and green environments"
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.blue.yml pull
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.blue.yml up -d
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.green.yml pull
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.green.yml up -d

        echo "Blue and green deployment completed"
        echo "Blue listening on http://localhost:8885/"
        echo "Green listening on http://localhost:8886/"
        # Default to green on first deployment for the environment
        echo "DYNAMIC_ENVIRONMENT_PORT=8886" >> deploy_production.env
        echo "COLOR_DEPLOYED=green" >> deploy_production.env
        echo "Note: Nginx router not started - run 'release' job to make frontend publicly available"
        exit 0
      fi
    # The nginx router is running, check which environment is currently released and deploy to the other
    - CURRENT_CONFIG=$(docker exec e4l-nginx-frontend-prod cat /etc/nginx/nginx.conf)
    - |
      if echo "$CURRENT_CONFIG" | grep "server e4l-frontend-blue-prod:80" | grep -v "^[[:space:]]*#" | grep -q .; then
        echo "Blue is currently released, deploying to green environment"
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.green.yml pull
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.green.yml up -d
        echo "Green deployment completed"
        echo "Service listening on http://localhost:8886/"
        echo "DYNAMIC_ENVIRONMENT_PORT=8886" >> deploy_production.env
        echo "COLOR_DEPLOYED=green" >> deploy_production.env
      else
        echo "Green is currently released, deploying to blue environment"
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.blue.yml pull
        docker compose -f ./e4l.frontend.docker/docker-compose.frontend.prod.blue.yml up -d
        echo "Blue deployment completed"
        echo "Service listening on http://localhost:8885/"
        echo "DYNAMIC_ENVIRONMENT_PORT=8885" >> deploy_production.env
        echo "COLOR_DEPLOYED=blue" >> deploy_production.env
      fi
  artifacts:
    reports:
      dotenv: deploy_production.env
  when: manual


release:
  rules:
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  stage: production
  tags:
    - shell-runner
  needs:
    - job: deploy_production
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    # Ensure nginx is running
    - docker compose -f ./e4l.frontend.docker/docker-compose.nginx-router.prod.yml up -d
  script:
    # Check which environment is currently active in the running nginx container
    - |
      CURRENT_CONFIG=$(docker exec e4l-nginx-frontend-prod cat /etc/nginx/nginx.conf)
      # If blue is active, release green
      if echo "$CURRENT_CONFIG" | grep "server e4l-frontend-blue-prod:80" | grep -v "^[[:space:]]*#" | grep -q .; then
        echo "Releasing green"
        sed -i 's/server e4l-frontend-blue-prod:80/# server e4l-frontend-blue-prod:80/' ./e4l.frontend.docker/nginx.conf
        sed -i 's/# server e4l-frontend-green-prod:80/server e4l-frontend-green-prod:80/' ./e4l.frontend.docker/nginx.conf
      else
        echo "Releasing blue"
        sed -i 's/server e4l-frontend-green-prod:80/# server e4l-frontend-green-prod:80/' ./e4l.frontend.docker/nginx.conf
        sed -i 's/# server e4l-frontend-blue-prod:80/server e4l-frontend-blue-prod:80/' ./e4l.frontend.docker/nginx.conf
      fi
    - docker compose -f ./e4l.frontend.docker/docker-compose.nginx-router.prod.yml up -d --force-recreate
    - echo "Release completed"
    - echo "Service is now live on http://localhost:8890/"
  when: manual
  environment:
    name: production
    url: http://localhost:8890/

rollback:
  rules:
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  stage: production
  tags:
    - shell-runner
  needs:
    - job: release
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  script:
    # Check which environment is currently active in the running nginx container
    - |
      CURRENT_CONFIG=$(docker exec e4l-nginx-frontend-prod cat /etc/nginx/nginx.conf)
      # If blue is active, roll back to green
      if echo "$CURRENT_CONFIG" | grep "server e4l-frontend-blue-prod:80" | grep -v "^[[:space:]]*#" | grep -q .; then
        echo "Rolling back from blue to green"
        sed -i 's/server e4l-frontend-blue-prod:80/# server e4l-frontend-blue-prod:80/' ./e4l.frontend.docker/nginx.conf
        sed -i 's/# server e4l-frontend-green-prod:80/server e4l-frontend-green-prod:80/' ./e4l.frontend.docker/nginx.conf
      else
        echo "Rolling back from green to blue"
        sed -i 's/server e4l-frontend-green-prod:80/# server e4l-frontend-green-prod:80/' ./e4l.frontend.docker/nginx.conf
        sed -i 's/# server e4l-frontend-blue-prod:80/server e4l-frontend-blue-prod:80/' ./e4l.frontend.docker/nginx.conf
      fi
    - docker compose -f ./e4l.frontend.docker/docker-compose.nginx-router.prod.yml up -d --force-recreate
    - echo "Rollback completed"
  when: manual
  environment:
    name: production
    url: http://localhost:8890/